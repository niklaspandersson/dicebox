<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DiceBox - Architecture Demo</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }

    h1 {
      text-align: center;
      color: #60a5fa;
      margin-bottom: 8px;
    }

    .subtitle {
      text-align: center;
      color: #64748b;
      margin-bottom: 24px;
    }

    .demo-container {
      max-width: 900px;
      margin: 0 auto;
    }

    .section {
      background: #1e293b;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .section h2 {
      color: #94a3b8;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-top: 0;
      margin-bottom: 16px;
    }

    .controls {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }

    button:hover {
      background: #2563eb;
    }

    button:disabled {
      background: #475569;
      cursor: not-allowed;
    }

    button.secondary {
      background: #475569;
    }

    button.secondary:hover {
      background: #64748b;
    }

    .log {
      background: #0f172a;
      border-radius: 8px;
      padding: 12px;
      font-family: monospace;
      font-size: 12px;
      max-height: 150px;
      overflow-y: auto;
    }

    .log-entry {
      margin-bottom: 4px;
      padding: 4px 8px;
      border-radius: 4px;
    }

    .log-entry.info {
      background: #1e3a5f;
      color: #60a5fa;
    }

    .log-entry.success {
      background: #14532d;
      color: #4ade80;
    }

    .log-entry.warn {
      background: #422006;
      color: #fbbf24;
    }

    .player-selector, .strategy-selector {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .player-btn, .strategy-btn {
      padding: 8px 16px;
      border-radius: 6px;
      background: #334155;
      border: 2px solid transparent;
      font-size: 13px;
    }

    .player-btn.active, .strategy-btn.active {
      border-color: #3b82f6;
      background: #1e3a5f;
    }

    .strategy-btn {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      min-width: 200px;
      text-align: left;
    }

    .strategy-btn__name {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .strategy-btn__desc {
      font-size: 11px;
      color: #94a3b8;
    }

    dice-roller-container {
      display: block;
      min-height: 200px;
    }

    .state-display {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
    }

    .state-card {
      background: #0f172a;
      border-radius: 8px;
      padding: 12px;
    }

    .state-card h3 {
      font-size: 12px;
      color: #64748b;
      margin: 0 0 8px 0;
      text-transform: uppercase;
    }

    .state-card pre {
      margin: 0;
      font-size: 11px;
      color: #94a3b8;
      white-space: pre-wrap;
    }

    .highlight-box {
      background: #1e3a5f;
      border: 1px solid #3b82f6;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 16px;
    }

    .highlight-box p {
      margin: 0;
      font-size: 13px;
      color: #94a3b8;
    }

    .highlight-box strong {
      color: #60a5fa;
    }

    .highlight-box code {
      background: #0f172a;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="demo-container">
    <h1>DiceBox Architecture Demo</h1>
    <p class="subtitle">Demonstrating the Strategy + View Factory Pattern</p>

    <!-- Strategy Selection -->
    <div class="section">
      <h2>Strategy Selection (View Factory in Action)</h2>
      <div class="highlight-box">
        <p>
          <strong>Key concept:</strong> Each strategy provides its own View component via <code>createView()</code>.
          Switch strategies to see completely different UIs - same dice state, different interaction models.
        </p>
      </div>
      <div class="strategy-selector" id="strategy-selector">
        <!-- Populated by JS -->
      </div>
    </div>

    <!-- Player Simulation -->
    <div class="section">
      <h2>Simulate Player</h2>
      <div class="player-selector">
        <button class="player-btn active" data-player="alice">Alice</button>
        <button class="player-btn" data-player="bob">Bob</button>
        <button class="player-btn" data-player="carol">Carol</button>
      </div>
      <p style="color: #64748b; font-size: 13px; margin-top: 12px; margin-bottom: 0;">
        Switch players to test multi-player mechanics.
      </p>
    </div>

    <!-- Dice Roller -->
    <div class="section">
      <h2>Dice Roller</h2>
      <div id="dice-mount"></div>
    </div>

    <!-- State Display -->
    <div class="section">
      <h2>Current State</h2>
      <div class="state-display">
        <div class="state-card">
          <h3>Strategy</h3>
          <pre id="strategy-display">-</pre>
        </div>
        <div class="state-card">
          <h3>Holders</h3>
          <pre id="holders-display">No holders</pre>
        </div>
        <div class="state-card">
          <h3>Dice Values</h3>
          <pre id="values-display">No values</pre>
        </div>
        <div class="state-card">
          <h3>Last Roller</h3>
          <pre id="roller-display">None</pre>
        </div>
      </div>
    </div>

    <!-- Event Log -->
    <div class="section">
      <h2>Network Messages (Simulated)</h2>
      <div class="controls">
        <button id="clear-log" class="secondary">Clear Log</button>
      </div>
      <div class="log" id="event-log"></div>
    </div>
  </div>

  <script type="module">
    import { createApp } from './app/App.js';

    // ─────────────────────────────────────────────────────────────
    // LOGGING
    // ─────────────────────────────────────────────────────────────

    const logEl = document.getElementById('event-log');

    function log(message, type = 'info') {
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logEl.appendChild(entry);
      logEl.scrollTop = logEl.scrollHeight;
    }

    document.getElementById('clear-log').addEventListener('click', () => {
      logEl.innerHTML = '';
    });

    // ─────────────────────────────────────────────────────────────
    // SETUP
    // ─────────────────────────────────────────────────────────────

    // Players (simulated)
    const players = {
      alice: { id: 'player-alice', username: 'Alice' },
      bob: { id: 'player-bob', username: 'Bob' },
      carol: { id: 'player-carol', username: 'Carol' },
    };

    let currentPlayer = players.alice;

    // Mock network service
    const mockNetwork = {
      broadcast: (type, payload) => {
        log(`${type}: ${JSON.stringify(payload)}`, 'info');
      },
    };

    // Create app
    const app = createApp({
      diceConfig: {
        diceSets: [
          { id: 'red', count: 5, color: '#ef4444' },
          { id: 'blue', count: 5, color: '#3b82f6' },
        ],
      },
      localPlayer: currentPlayer,
      network: mockNetwork,
      strategyId: 'drag-pickup',
    });

    // Mount dice roller
    app.mount('#dice-mount');

    log('App initialized with DragPickup strategy', 'success');

    // ─────────────────────────────────────────────────────────────
    // STRATEGY SWITCHER
    // ─────────────────────────────────────────────────────────────

    const strategySelectorEl = document.getElementById('strategy-selector');
    const btn = document.createElement('button');
    btn.className = 'strategy-btn active';
    btn.innerHTML = `
      <span class="strategy-btn__name">Drag to Pick Up</span>
      <span class="strategy-btn__desc">Drag across dice to pick them up, release to roll.</span>
    `;
    strategySelectorEl.appendChild(btn);

    // ─────────────────────────────────────────────────────────────
    // STATE DISPLAY
    // ─────────────────────────────────────────────────────────────

    function updateStateDisplay() {
      const store = app.diceStore;

      // Strategy
      document.getElementById('strategy-display').textContent = app.currentStrategyId;

      // Holders
      const holdersEl = document.getElementById('holders-display');
      if (store.holders.size === 0) {
        holdersEl.textContent = 'No holders';
      } else {
        holdersEl.textContent = [...store.holders.entries()]
          .map(([setId, h]) => `${setId}: ${h.username}`)
          .join('\n');
      }

      // Values
      const valuesEl = document.getElementById('values-display');
      if (store.diceValues.size === 0) {
        valuesEl.textContent = 'No values';
      } else {
        valuesEl.textContent = [...store.diceValues.entries()]
          .map(([setId, v]) => `${setId}: [${v.join(', ')}]`)
          .join('\n');
      }

      // Last Roller
      const rollerEl = document.getElementById('roller-display');
      if (store.lastRoller.size === 0) {
        rollerEl.textContent = 'None';
      } else {
        rollerEl.textContent = [...store.lastRoller.entries()]
          .map(([setId, r]) => `${setId}: ${r.username}`)
          .join('\n');
      }
    }

    // Subscribe to state changes
    app.diceStore.subscribe(() => {
      updateStateDisplay();
    });

    updateStateDisplay();

    // ─────────────────────────────────────────────────────────────
    // PLAYER SWITCHING
    // ─────────────────────────────────────────────────────────────

    document.querySelectorAll('.player-btn').forEach((btn) => {
      btn.addEventListener('click', () => {
        // Update UI
        document.querySelectorAll('.player-btn').forEach((b) => b.classList.remove('active'));
        btn.classList.add('active');

        // Switch player
        const playerId = btn.dataset.player;
        currentPlayer = players[playerId];

        // Update app's local player reference
        app.container.registerInstance('localPlayer', currentPlayer);

        // Recreate strategy with new player context
        app.setStrategy(app.currentStrategyId);

        log(`Switched to player: ${currentPlayer.username}`, 'warn');
      });
    });

    // ─────────────────────────────────────────────────────────────
    // EXPOSE FOR DEBUGGING
    // ─────────────────────────────────────────────────────────────

    window.app = app;
    window.players = players;

    log('Access window.app in console for debugging', 'info');
  </script>
</body>
</html>
